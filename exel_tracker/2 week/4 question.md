# Как реализовать ограничение по количеству запросов в секунду?

Ограничение по количеству запросов в секунду (rate limiting) — это техника для предотвращения избыточных запросов от одного клиента за короткий промежуток времени. В Nginx это можно реализовать с помощью модуля `ngx_http_limit_req_module`.

# Пример настройки ограничений на количество запросов с использованием `limit_req_zone` и `limit_req`:

1. Настройка зоны для хранения состояния запросов (`limit_req_zone`):

В этом шаге создается зона, в которой будут храниться данные о количестве запросов. Эта зона может быть основана на IP-адресе клиента, или на другом идентификаторе, если нужно ограничить запросы для конкретных пользователей.

В конфигурации Nginx добавляется директива `limit_req_zone`, где:

- `$binary_remote_addr` — используется для отслеживания запросов по IP-адресу клиента.

- `zone=one:10m` — создает зону памяти на 10 МБ.

- `rate=1r/s` — лимит на 1 запрос в секунду для каждого клиента.

Пример:

```
http {
    limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;
    ...
}
```

2. Ограничение количества запросов для определенной локации (limit_req):

Далее, в блоке `server` или `location` настраивается непосредственно ограничение запросов с использованием директивы `limit_req`, которая будет применять лимит, определенный в `limit_req_zone`.

Пример:

```
server {
    ...
    location /api/ {
        limit_req zone=one burst=5 nodelay;
        # Конфигурация для обработки запросов
    }
}
```

- `zone=one` — это имя зоны, созданной в предыдущем шаге.

- `burst=5` — это параметр, который определяет "всплеск" (сколько запросов можно отправить за один раз, если еще не достигнут лимит). В данном случае, клиент может сделать до 5 запросов подряд, прежде чем будет применен лимит.

- `nodelay` — означает, что дополнительные запросы будут отклоняться немедленно, а не откладываться на некоторое время (если это не установлено, запросы могут быть отклонены с задержкой).

# Как это работает:

- Когда клиент делает запрос, Nginx проверяет, не превысил ли он лимит по количеству запросов за секунду (в данном случае 1 запрос в секунду).

- Если превышен лимит, запрос может быть отклонен с ошибкой `503 Service Unavailable`, или же может быть применено ожидание, если настроен параметр `burst`.

- Параметр `burst` позволяет клиентам сделать несколько запросов подряд, прежде чем они начнут отклоняться, что дает некоторую гибкость в случае пиковых нагрузок.

# Полный пример конфигурации:

```
http {
    # Настроим лимит на 1 запрос в секунду с всплесками
    limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;

    server {
        listen 80;

        location /api/ {
            # Применяем лимит
            limit_req zone=one burst=5 nodelay;

            # Остальная конфигурация для обработки запросов
            proxy_pass http://backend;
        }
    }
}
```

# Параметры:

- `rate=1r/s` — лимит на 1 запрос в секунду.

- `burst=5` — позволяет клиенту отправить до 5 запросов без ожидания, после чего запросы начнут отклоняться, если будут превышать лимит.

- `nodelay` — заставляет запросы сразу отклоняться, если превышен лимит (без задержки).

# Примечания:

1. `limit_req` — применяется для ограничения запросов по времени. Это работает на уровне запросов, поступающих на сервер.

2. Вы также можете использовать `limit_conn`, чтобы ограничить количество одновременных соединений от одного клиента.

Такой подход позволяет эффективно управлять нагрузкой на сервер и защищать его от DDoS атак или злоупотреблений.